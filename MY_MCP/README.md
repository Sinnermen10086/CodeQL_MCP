# MCP本地代码安全分析工具

## 项目概述
MCP本地代码安全分析工具是一个集成了多种安全分析技术的代码审计系统，能够自动化地对项目进行全面安全分析，发现潜在安全漏洞并提供专业修复建议。

## 核心功能

- **多维度安全分析**：集成OSV-Scanner和CodeQL两大静态分析工具
- **智能查询选择**：根据用户需求和项目语言自动选择最合适的CodeQL查询规则
- **大模型评估**：利用DeepSeek模型对分析结果进行综合评估和解读
- **交互式安全咨询**：提供聊天模式，回答安全相关问题

## 工作流程

1. **项目分析**：自动分析项目结构、使用的框架和语言
2. **依赖扫描**：使用OSV-Scanner检测第三方依赖中的已知漏洞
3. **代码安全分析**：使用CodeQL进行代码级安全漏洞扫描
4. **智能规则筛选**：根据用户需求和关键词自动选择最适合的分析规则
5. **大模型评估**：将分析数据提交给模型生成综合安全报告和修复建议

## 使用方法

### 命令行模式
```
python mcp_local.py --analyze "项目路径"
```

### 交互式模式
```
python mcp_local.py

> 分析项目 "C:\路径\项目名" sql注入
```

## 支持的漏洞类型

- SQL注入
- XSS跨站脚本
- 命令注入
- 路径遍历
- 信息泄露
- 反序列化漏洞
- 文件上传漏洞
- LDAP注入
- XXE漏洞
- 等多种安全风险

## 技术特点

- **智能QL路径选择**：通过多层次评分机制选择最适合的分析规则
- **自动语言检测**：自动识别项目主要编程语言
- **风险模式识别**：能识别危险API调用和风险代码模式
- **综合风险评分**：提供1-10分的项目安全风险评分

## 系统要求

- Python 3.7+
- CUDA支持(GPU加速，可选)
- CodeQL CLI工具
- OSV-Scanner

## 配置说明
在mcp_local.py文件开头可配置：
- MODEL_PATH：本地模型路径
- CODEQL_PATH：CodeQL可执行文件路径
- CODEQL_QUERIES：CodeQL规则库路径

### 路径配置详解
- **MODEL_PATH**：指向DeepSeek模型的本地路径，例如"E:\models\deepseek-coder-33b-instruct"
- **CODEQL_PATH**：CodeQL CLI工具的安装路径，例如"E:\codeql\codeql.exe"
- **CODEQL_QUERIES**：CodeQL规则库路径，例如"E:\codeql\codeql-main"
- **结果输出路径**：默认在项目根目录的results文件夹，可通过修改mcp_local.py中的RESULTS_DIR变量自定义
- **OSV-Scanner路径**：建议通过全局安装，确保在系统PATH中可访问

> **重要提示**：本项目主要使用绝对路径，以保证项目代码与使用工具的独立性。使用者在部署后，需要修改项目中的各个路径以适配本地环境，同时安装requirements.txt中的依赖。

对于不同操作系统：
- Windows：使用反斜杠"\"或双反斜杠"\\"作为路径分隔符
- Linux/MacOS：使用正斜杠"/"作为路径分隔符

## 项目结构

```
MCP/
├── mcp_local.py        # 本地分析主程序
├── requirements.txt    # 依赖库清单
├── MCP_Tools/          # 工具模块目录
│   ├── project_analyzer.py  # 项目分析工具
│   └── CodeQL/             # CodeQL相关模块
│       ├── codeql_wrapper.py  # CodeQL调用封装
│       └── query_scanner.py   # CodeQL查询规则扫描器
└── results/            # 分析结果输出目录
```

## 安全报告内容

系统生成的安全报告包含以下内容：
1. 总体安全评分(1-10分)
2. 代码安全性分析
3. 依赖安全性分析
4. 综合风险评估
5. 修复建议
6. 风险控制策略
7. 监控计划

## 扩展功能

- 支持更多编程语言
- 添加更多安全规则
- 集成其他静态分析工具

## 注意事项

- 确保CodeQL CLI正确安装并可在路径中访问，建议CodeQL扫描数据库直接放在CodeQL目录下例如"E:\codeql\codeql-main"
- 大型项目分析可能需要较长时间
- 分析结果仅供参考，建议由安全专家进行最终评估 